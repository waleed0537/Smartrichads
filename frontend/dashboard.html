<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Richads</title>
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/finances.css">
    <link rel="stylesheet" href="/css/campaigns.css">
    <link rel="stylesheet" href="/css/create-campaign.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .mobile-menu-toggle {
        display: none; /* Hidden by default */
        /* Keep your existing mobile styles here */
    }
        .date-filter {
            position: relative;
            display: inline-block;
        }

        .date-filter-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: none;
            border-radius: 0.375rem;
            color: #374151;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .date-filter-btn:hover {
            background: #e5e7eb;
        }

        .date-picker-popup {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1rem;
            min-width: 320px;
            z-index: 50;
            border: 1px solid #e5e7eb;
        }

        .date-picker-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .date-picker-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .date-picker-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .date-picker-group input {
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .date-picker-group input:focus {
            outline: none;
            border-color: #6d28d9;
            box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.1);
        }

        .date-picker-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .cancel-btn {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: none;
            border-radius: 0.375rem;
            color: #374151;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .cancel-btn:hover {
            background: #e5e7eb;
        }

        .apply-btn {
            padding: 0.5rem 1rem;
            background: #6d28d9;
            border: none;
            border-radius: 0.375rem;
            color: white;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .apply-btn:hover {
            background: #5b21b6;
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
            display: flex; /* Show only on mobile */
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
            background: #ffffff;
            border: none;
            padding: 0.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Keep existing mobile sidebar styles */
        .sidebar {
            transform: translateX(-100%);
        }
        .sidebar.active {
            transform: translateX(0);
        }
            .date-picker-popup {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 320px;
            }
        }

        .hidden {
            display: none;
        }

        .verification-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f9fafb;
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem;
        }

        .verification-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: none;
            border-radius: 0.375rem;
            color: #374151;
            font-size: 0.875rem;
            cursor: pointer;
            margin-bottom: 2rem;
            transition: background-color 0.2s;
        }

        .back-button:hover {
            background: #e5e7eb;
        }

        h1 {
            font-size: 1.875rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 1.5rem;
        }

        .verification-text {
            color: #6b7280;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .verification-text a {
            color: #6d28d9;
            text-decoration: none;
        }

        .verification-text a:hover {
            text-decoration: underline;
        }

        .status-box {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 2rem 0;
        }

        .status-text {
            color: #6d28d9;
            font-weight: 500;
        }

        .questions-box {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 0.5rem;
        }

        .questions-box h2 {
            font-size: 1.25rem;
            font-weight: 500;
            color: #111827;
            margin-bottom: 1rem;
        }

        .questions-box ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .questions-box li {
            color: #6b7280;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .questions-box li::before {
            content: "â€¢";
            color: #6d28d9;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .verification-container {
                padding: 1rem;
            }

            .verification-content {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }
        }
    </style>
    <script src="../backend/auth-handler.js"></script>
</head>

<body>
    <div class="dashboard">
        <!-- Mobile Menu Toggle Button -->
        <button class="mobile-menu-toggle" aria-label="Toggle menu" onclick="toggleSidebar()">
            <i class="fa-solid fa-bars"></i>
        </button>

        <!-- Left Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div>
                <button class="close-menu" onclick="toggleSidebar()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <nav class="nav-menu">
                <ul>
                    <li class="active">
                        <a href="#offers">
                            <i class="fa-solid fa-box"></i>
                            <span>Offers</span>
                        </a>
                    </li>
                    <li>
                        <a href="#statistics">
                            <i class="fa-solid fa-chart-line"></i>
                            <span>Statistics</span>
                        </a>
                    </li>
                    <li>
                        <a href="#add-funds" onclick="togglePaymentForm()">
                            <i class="fa-solid fa-wallet"></i>
                            <span>Add Funds</span>
                        </a>
                    </li>

                    <li>
                        <a href="#finances">
                            <i class="fa-solid fa-coins"></i>
                            <span>Finances</span>
                        </a>
                    </li>
                    <li>
                        <a href="#campaigns" onclick="showSection('campaignsSection')">
                            <i class="fa-solid fa-bullhorn"></i>
                            <span>Campaigns</span>
                        </a>
                    </li>
                    <li>
                        <a href="#create-campaign" class="nav-link"
                            onclick="showSection('createCampaignSection'); return false;">
                            <i class="fa-solid fa-plus"></i>
                            <span>Create Campaign</span>
                        </a>
                    </li>

                    <li>
                        <a href="#settings">
                            <i class="fa-solid fa-gear"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>

                <div class="logout-section">
                    <a href="#logout" class="logout-link" onclick="logout()">
                        <i class="fa-solid fa-sign-out-alt"></i>
                        <span>Log out</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <h1>Offers</h1>
                <div class="header-actions">
                    <div class="balance">
                        <span class="balance-label">Balance</span>
                        <span class="balance-amount">$ 0</span>
                    </div>
                    <button class="add-funds-button" onclick="togglePaymentForm()">Add funds</button>
                    <button class="icon-button"><i class="fa-solid fa-bell"></i></button>
                    <button class="icon-button"><i class="fa-solid fa-search"></i></button>
                </div>
            </header>

            <div class="content-area">
                <!-- No Offers State -->
                <div class="empty-state" id="emptyState">
                    <div class="megaphone-icon">
                        <i class="fa-solid fa-bullhorn"></i>
                    </div>
                    <h2>No offers yet</h2>
                    <p>To add an offer, contact your manager</p>
                </div>

                <div class="payment-form hidden" id="paymentForm">
                    <div class="payment-form-header">
                        <h2>Add Funds</h2>
                    </div>
                    <form class="payment-form-content">
                        <div class="payment-methods">
                            <button type="button" class="payment-method active" onclick="selectPaymentMethod('stripe')">
                                <i class="fa-brands fa-stripe"></i>
                                <span></span>
                            </button>
                            <button type="button" class="payment-method" onclick="selectPaymentMethod('paypal')">
                                <i class="fa-brands fa-paypal"></i>
                                <span></span>
                            </button>
                        </div>

                        <div class="form-section stripe-section">
                            <div class="form-group">
                                <label>Card Number</label>
                                <input type="text" name="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19"
                                    required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Expiry Date</label>
                                    <input type="text" name="expiryDate" placeholder="MM/YY" maxlength="5" required>
                                </div>
                                <div class="form-group">
                                    <label>CVC</label>
                                    <input type="text" name="cvc" placeholder="123" maxlength="3" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-section paypal-section hidden">
                            <div class="form-group">
                                <label>PayPal Email</label>
                                <input type="email" name="paypalEmail" id="paypalEmail" placeholder="your@email.com">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" name="amount" placeholder="Enter amount" min="1" step="0.01" required>
                        </div>

                        <button type="submit" class="submit-button">Submit for Approval</button>
                    </form>
                </div>
                <div id="verificationPage" class="verification-container hidden">
                    <div class="verification-content">
                        <button class="back-button" onclick="hideVerificationPage()">
                            <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
                        </button>

                        <h1>We are veryfing your documents</h1>

                        <p class="verification-text">
                            Verification on weekdays occurs within 24 hours. On the weekend, please, contact our support
                            in live chat or via email at
                            <a href="mailto:support@smartrichads.com">support@smartrichads.com</a>.
                        </p>

                        <p class="verification-text">
                            We will let you know as soon as your verification status is updated. No additional actions
                            are required. After this, you will automatically get access to all RichAds features.
                        </p>

                        <div class="status-box">
                            <p>Status: <span class="status-text">Waiting verification</span> <i
                                    class="fa-solid fa-spinner fa-spin"></i></p>
                        </div>

                        <div class="questions-box">
                            <h2>If you have any questions:</h2>
                            <ul>
                                <li>Contact your personal manager directly</li>
                                <li>Use live-chat in the right corner of the screen</li>
                                <li>Email us at <a href="mailto:support@smartrichads.com">support@smartrichads.com</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="createCampaignSection" class="create-campaign-section hidden">
                    <div class="create-campaign-container">
                        <div class="campaign-header">
                            <div>
                                <input id="campaignFormTitle" type="text" placeholder="Enter Campaign Name">
                                <span id="campaignId" class="campaign-id"></span>
                            </div>
                            <button class="btn btn-secondary" onclick="showSection('campaignsSection')">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>

                        <div class="campaign-steps">
                            <a href="#" class="step-item active">
                                <span class="step-number">1</span>
                                <span>Optimization strategy</span>
                            </a>
                            <a href="#" class="step-item">
                                <span class="step-number">2</span>
                                <span>Creative</span>
                            </a>
                            <a href="#" class="step-item">
                                <span class="step-number">3</span>
                                <span>Targeting</span>
                            </a>
                            <a href="#" class="step-item">
                                <span class="step-number">4</span>
                                <span>Goal</span>
                            </a>
                            <a href="#" class="step-item">
                                <span class="step-number">5</span>
                                <span>Budget</span>
                            </a>
                        </div>

                        <div class="campaign-form">
                            <div class="form-section">
                                <div class="form-section-header">
                                    <h2 class="form-section-title">Optimization strategy</h2>
                                </div>

                                <div class="optimization-options">
                                    <div class="optimization-card disabled" onclick="selectOptimization('target-cpa')">
                                        <div class="card-header">
                                            <span class="card-title">Target CPA</span>
                                            <span class="new-badge">New</span>
                                        </div>
                                        <p class="card-description">
                                            Use for all conversion-focused campaigns.
                                        </p>
                                        <button class="btn btn-secondary">Setup tracker to unlock Target CPA</button>
                                    </div>

                                    <div class="optimization-card" onclick="selectOptimization('performance')">
                                        <div class="card-header">
                                            <span class="card-title">Performance Mode</span>
                                            <span class="new-badge">New</span>
                                        </div>
                                        <p class="card-description">
                                            Fresh whitelist every day. Get the best sources according to our rating for
                                            an effective start of a new campaign.
                                        </p>
                                    </div>

                                    <div class="optimization-card active" onclick="selectOptimization('manual')">
                                        <div class="card-header">
                                            <span class="card-title">Manual CPC</span>
                                        </div>
                                        <p class="card-description">
                                            Optimize manually or with an external optimization tool. Use only when it
                                            necessary.
                                        </p>
                                    </div>
                                </div>

                                <div class="recommended-cpc">
                                    <div class="recommended-cpc-header">
                                        <span class="recommended-cpc-title">Recommended CPC</span>
                                        <span class="cpc-range">$0.001 - $0.003</span>
                                    </div>
                                    <p class="card-description">
                                        Based on competitors' bids in selected GEOs
                                    </p>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button class="btn btn-secondary"
                                    onclick="showSection('campaignsSection')">Cancel</button>
                                <button class="btn btn-primary">Continue</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-section creative-section" id="creativeSection">
                        <div class="form-section-header">
                            <h2 class="form-section-title">Creative</h2>
                        </div>

                        <div class="creative-header">
                            <div class="impression-priority">
                                <label>Impression priority</label>
                                <div class="priority-options">
                                    <button class="priority-btn active">CTR</button>
                                    <button class="priority-btn">CVR</button>
                                </div>
                            </div>
                        </div>

                        <div class="creative-table">
                            <div class="table-header">
                                <div class="col-icon">Icon</div>
                                <div class="col-url">URL</div>
                                <div class="col-title">Title</div>
                                <div class="col-message">Message</div>
                                <div class="col-banner">Banner</div>
                                <div class="col-actions">Actions</div>
                            </div>

                            <div class="creative-rows">
                                <!-- Repeat this block for each creative row -->
                                <div class="creative-row">
                                    <div class="col-icon">
                                        <button class="upload-btn">
                                            <i class="fa-solid fa-upload"></i>
                                        </button>
                                    </div>
                                    <div class="col-url">
                                        <input type="text" placeholder="Type URL...">
                                    </div>
                                    <div class="col-title">
                                        <input type="text" placeholder="Type title...">
                                    </div>
                                    <div class="col-message">
                                        <input type="text" placeholder="Type message...">
                                    </div>
                                    <div class="col-banner">
                                        <button class="upload-btn">
                                            <i class="fa-solid fa-upload"></i>
                                        </button>
                                    </div>
                                    <div class="col-actions">
                                        <button class="action-btn copy">
                                            <i class="fa-regular fa-copy"></i>
                                        </button>
                                        <button class="action-btn delete">
                                            <i class="fa-regular fa-trash-can"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <button class="add-creative-btn">
                                <i class="fa-solid fa-plus"></i>
                                Creative
                            </button>
                        </div>
                    </div>
                    <!-- Add to dashboard.html inside main-content div -->
                    <div class="finances-section hidden" id="financesSection">
                        <div class="finances-content">
                            <div class="finance-cards">
                                <div class="finance-card">
                                    <div class="card-header">Balance</div>
                                    <div class="card-amount">$ 0</div>
                                </div>
                                <div class="finance-card">
                                    <div class="card-header">Unpaid Approved Spend</div>
                                    <div class="card-amount">$ 0</div>
                                </div>
                                <div class="finance-card">
                                    <div class="card-header">Hold Spend</div>
                                    <div class="card-amount">$ 0</div>
                                </div>
                                <div class="finance-card summary-card">
                                    <div class="summary-item">
                                        <span>Total Payments</span>
                                        <span>-</span>
                                    </div>
                                    <div class="summary-item">
                                        <span>Total Expenses</span>
                                        <span>-</span>
                                    </div>
                                </div>
                            </div>

                            <div class="transactions-section">
                                <div class="transaction-tabs">
                                    <button class="tab-btn active" data-tab="all">
                                        <i class="fa-solid fa-list"></i>
                                        All transactions
                                    </button>
                                    <button class="tab-btn" data-tab="payments">
                                        <i class="fa-solid fa-arrow-down"></i>
                                        Payments
                                    </button>
                                    <button class="tab-btn" data-tab="expenses">
                                        <i class="fa-solid fa-arrow-up"></i>
                                        Expenses
                                    </button>
                                    <button class="tab-btn" data-tab="balance">
                                        <i class="fa-solid fa-wallet"></i>
                                        Balance
                                    </button>
                                </div>

                                <div class="date-filter">
                                    <button class="date-filter-btn">
                                        <i class="fa-regular fa-calendar"></i>
                                        <span id="dateRangeText">Jan 31, 2025 0:00 - Jan 31, 2025 18:07</span>
                                    </button>
                                    <div class="date-picker-popup hidden">
                                        <div class="date-picker-content">
                                            <div class="date-picker-group">
                                                <label>Start Date & Time</label>
                                                <input type="date" id="startDate" value="2025-01-31">
                                                <input type="time" id="startTime" value="00:00">
                                            </div>
                                            <div class="date-picker-group">
                                                <label>End Date & Time</label>
                                                <input type="date" id="endDate" value="2025-01-31">
                                                <input type="time" id="endTime" value="18:07">
                                            </div>
                                            <div class="date-picker-actions">
                                                <button class="cancel-btn">Cancel</button>
                                                <button class="apply-btn">Apply</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="no-transactions">
                                    <i class="fa-regular fa-file"></i>
                                    <h3>No transactions found</h3>
                                    <p>You have no data for the selected period</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Campaigns Section -->
                    <div id="campaignsSection" class="campaigns-section hidden">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Status</th>
                                        <th>Impressions</th>
                                        <th>Winrate</th>
                                        <th>Clicks</th>
                                        <th>CTR</th>
                                        <th>Conv</th>
                                        <th>Spend</th>
                                        <th>Microbidding</th>
                                        <th>eCPC</th>
                                        <th>eCPA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Campaign_USA</td>
                                        <td><span class="status-badge">Active</span></td>
                                        <td>4,290,820</td>
                                        <td>47%</td>
                                        <td>3,838</td>
                                        <td>0.89%</td>
                                        <td><i class="fa-solid fa-lock lock-icon"></i></td>
                                        <td>$35</td>
                                        <td class="bid-type">+ Custom Bid</td>
                                        <td>$0.009</td>
                                        <td><i class="fa-solid fa-lock lock-icon"></i></td>
                                    </tr>
                                    <tr>
                                        <td>Campaign_IDN_NEW</td>
                                        <td><span class="status-badge">Active</span></td>
                                        <td>4,484,940</td>
                                        <td>51%</td>
                                        <td>3,945</td>
                                        <td>0.87%</td>
                                        <td><i class="fa-solid fa-lock lock-icon"></i></td>
                                        <td>$32</td>
                                        <td class="bid-type">+ Custom Bid</td>
                                        <td>$0.008</td>
                                        <td><i class="fa-solid fa-lock lock-icon"></i></td>
                                    </tr>
                                    <tr>
                                        <td>Campaign_IND_Start</td>
                                        <td><span class="status-badge">Active</span></td>
                                        <td>3,913,540</td>
                                        <td>36%</td>
                                        <td>3,670</td>
                                        <td>0.93%</td>
                                        <td><i class="fa-solid fa-lock lock-icon"></i></td>
                                        <td>$30</td>
                                        <td class="bid-type">âŸ‹ CPC * 2</td>
                                        <td>$0.008</td>
                                        <td><i class="fa-solid fa-lock lock-icon"></i></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

        </main>
    </div>

    <script>
        // Initialize variables
        let currentView = 'offers';

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const body = document.body;
            sidebar.classList.toggle('active');
            body.classList.toggle('menu-open');

            let overlay = document.getElementById('mobileOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'mobileOverlay';
                overlay.className = 'mobile-overlay';
                overlay.onclick = toggleSidebar;
                document.body.appendChild(overlay);
            }
            overlay.classList.toggle('active');
        }

        function showSection(sectionId) {
            const sections = [
                'emptyState',
                'paymentForm',
                'financesSection',
                'campaignsSection',
                'createCampaignSection'
            ];

            sections.forEach(section => {
                const elem = document.getElementById(section);
                if (elem) elem.classList.add('hidden');
            });

            const targetSection = document.getElementById(sectionId);
            if (targetSection) targetSection.classList.remove('hidden');

            // Update header title based on section
            const topNavTitle = document.querySelector('.top-nav h1');
            switch (sectionId) {
                case 'createCampaignSection':
                    topNavTitle.textContent = 'Create Campaign';
                    break;
                case 'campaignsSection':
                    topNavTitle.textContent = 'Campaigns';
                    break;
                case 'financesSection':
                    topNavTitle.textContent = 'Finances';
                    break;
                default:
                    topNavTitle.textContent = 'Offers';
            }

            // Update active nav item
            document.querySelectorAll('.nav-menu li').forEach(item => {
                item.classList.remove('active');
            });

            // Set active state based on section
            let activeSelector;
            switch (sectionId) {
                case 'createCampaignSection':
                    activeSelector = 'a[href="#create-campaign"]';
                    break;
                case 'campaignsSection':
                    activeSelector = 'a[href="#campaigns"]';
                    break;
                case 'financesSection':
                    activeSelector = 'a[href="#finances"]';
                    break;
                default:
                    activeSelector = 'a[href="#offers"]';
            }

            const activeNavItem = document.querySelector(activeSelector)?.parentElement;
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }
        }
        function validateForm(currentPaymentMethod) {
            // Get the payment form
            const paymentForm = document.querySelector('.payment-form-content');
            // Get or create status label
            let statusLabel = document.querySelector('.payment-status-label');
            if (!statusLabel) {
                statusLabel = document.createElement('div');
                statusLabel.className = 'payment-status-label';
                paymentForm.appendChild(statusLabel);
            }

            // Reset error states
            statusLabel.textContent = '';
            statusLabel.className = 'payment-status-label';

            // Validate amount
            const amountInput = paymentForm.querySelector('input[name="amount"]');
            const amount = amountInput.value.trim();
            if (!amount || parseFloat(amount) <= 0) {
                statusLabel.textContent = 'Invalid amount. Please enter a positive number.';
                statusLabel.classList.add('error');
                return false;
            }

            // Validate payment method-specific fields
            if (currentPaymentMethod === 'stripe') {
                const cardNumber = paymentForm.querySelector('input[name="cardNumber"]').value.trim().replace(/\s/g, '');
                const expiryDate = paymentForm.querySelector('input[name="expiryDate"]').value.trim();
                const cvc = paymentForm.querySelector('input[name="cvc"]').value.trim();

                // Basic validation
                if (!cardNumber || cardNumber.length < 13) {
                    statusLabel.textContent = 'Invalid card number.';
                    statusLabel.classList.add('error');
                    return false;
                }

                if (!expiryDate || !expiryDate.includes('/')) {
                    statusLabel.textContent = 'Invalid expiry date. Use MM/YY format.';
                    statusLabel.classList.add('error');
                    return false;
                }

                if (!cvc || cvc.length < 3) {
                    statusLabel.textContent = 'Invalid CVC. Must be 3-4 digits.';
                    statusLabel.classList.add('error');
                    return false;
                }
            } else if (currentPaymentMethod === 'paypal') {
                const paypalEmail = document.getElementById('paypalEmail').value.trim();
                if (!paypalEmail || !paypalEmail.includes('@')) {
                    statusLabel.textContent = 'Please enter a valid PayPal email.';
                    statusLabel.classList.add('error');
                    return false;
                }
            }

            return true;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const paymentForm = document.querySelector('.payment-form-content');
            const paymentFormContainer = document.getElementById('paymentForm');
            const verificationPage = document.getElementById('verificationPage');
            const statusLabel = document.createElement('div');
            statusLabel.className = 'payment-status-label';
            paymentForm.appendChild(statusLabel);

            // Card number formatting
            const cardNumberInput = paymentForm.querySelector('input[name="cardNumber"]');
            cardNumberInput.addEventListener('input', function (e) {
                let value = this.value.replace(/\D/g, '');
                value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
                if (value.length > 19) return;
                this.value = value;
            });

            // Expiry date formatting
            const expiryDateInput = paymentForm.querySelector('input[name="expiryDate"]');
            expiryDateInput.addEventListener('input', function (e) {
                let value = this.value.replace(/\D/g, '');
                if (value.length > 4) return;

                if (value.length >= 2) {
                    value = value.slice(0, 2) + '/' + value.slice(2);
                }

                this.value = value;
            });

            // CVC formatting
            const cvcInput = paymentForm.querySelector('input[name="cvc"]');
            cvcInput.addEventListener('input', function (e) {
                this.value = this.value.replace(/\D/g, '');
            });

            // Email validation function (for PayPal)
            function validateEmail(email) {
                const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return regex.test(email);
            }

            // Card number validation using Luhn algorithm
            function validateCardNumber(number) {
                if (!/^\d+$/.test(number)) return false;

                let sum = 0;
                let isEven = false;

                for (let i = number.length - 1; i >= 0; i--) {
                    let digit = parseInt(number.charAt(i), 10);

                    if (isEven) {
                        digit *= 2;
                        if (digit > 9) {
                            digit -= 9;
                        }
                    }

                    sum += digit;
                    isEven = !isEven;
                }

                return (sum % 10) === 0;
            }

            // Expiry date validation
            function validateExpiryDate(date) {
                const regex = /^(0[1-9]|1[0-2])\/\d{2}$/;
                if (!regex.test(date)) return false;

                const [month, year] = date.split('/');
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear() % 100;
                const currentMonth = currentDate.getMonth() + 1;

                const expYear = parseInt(year, 10);
                const expMonth = parseInt(month, 10);

                return expYear > currentYear ||
                    (expYear === currentYear && expMonth >= currentMonth);
            }

            // CVC validation
            function validateCVC(cvc) {
                return /^\d{3,4}$/.test(cvc);
            }

            // Form validation function


            // Form submission handler
            paymentForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                // Determine current payment method
                const currentPaymentMethod = document.querySelector('.payment-method.active').querySelector('i').classList.contains('fa-stripe') ? 'stripe' : 'paypal';

                // Validate form
                if (!validateForm(currentPaymentMethod)) {
                    return;
                }

                // Prepare form data
                let formData = {
                    paymentMethod: currentPaymentMethod,
                    amount: paymentForm.querySelector('input[name="amount"]').value
                };

                // Add method-specific details
                if (currentPaymentMethod === 'stripe') {
                    formData.cardNumber = paymentForm.querySelector('input[name="cardNumber"]').value.replace(/\s/g, '');
                    formData.expiryDate = paymentForm.querySelector('input[name="expiryDate"]').value;
                    formData.cvc = paymentForm.querySelector('input[name="cvc"]').value;
                } else {
                    formData.paypalEmail = document.getElementById('paypalEmail').value;
                }

                try {
                    // Send payment data
                    const response = await fetch('/api/payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            credentials: 'include'
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // Show verification page
                        if (verificationPage && paymentFormContainer) {
                            verificationPage.classList.remove('hidden');
                            paymentFormContainer.classList.add('hidden');

                            // Reset form
                            paymentForm.reset();
                            selectPaymentMethod('stripe');
                            checkPaymentStatus(data.paymentId);
                        }
                    } else {
                        const data = await response.json();
                        statusLabel.textContent = data.error || 'Payment submission failed.';
                        statusLabel.classList.add('error');
                    }
                } catch (error) {
                    console.error('Payment error:', error);
                    statusLabel.textContent = 'An error occurred. Please try again.';
                    statusLabel.classList.add('error');
                }
            });
        });

        // Add payment status checking
        function checkPaymentStatus(paymentId) {
            fetch(`/api/payment/${paymentId}/status`, {
                method: 'GET',
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to check payment status');
                    return response.json();
                })
                .then(data => {
                    const statusText = document.querySelector('.status-text');
                    const spinner = document.querySelector('.status-text + i');

                    if (statusText && spinner) {
                        if (data.status === 'approved') {
                            statusText.textContent = 'Approved';
                            spinner.classList.remove('fa-spinner', 'fa-spin');
                            spinner.classList.add('fa-check');
                            spinner.style.color = '#10b981';
                        } else if (data.status === 'rejected') {
                            statusText.textContent = 'Rejected';
                            spinner.classList.remove('fa-spinner', 'fa-spin');
                            spinner.classList.add('fa-times');
                            spinner.style.color = '#ef4444';
                        } else {
                            // Still pending, check again in 30 seconds
                            setTimeout(() => checkPaymentStatus(paymentId), 30000);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking payment status:', error);
                });
        }
        // Payment method selection function
        function selectPaymentMethod(method) {
            const buttons = document.querySelectorAll('.payment-method');
            const stripeSect = document.querySelector('.stripe-section');
            const paypalSect = document.querySelector('.paypal-section');

            // Get all input elements
            const stripeInputs = stripeSect.querySelectorAll('input');
            const paypalInput = paypalSect.querySelector('input');

            // Reset buttons and requirements
            buttons.forEach(btn => btn.classList.remove('active'));
            stripeInputs.forEach(input => input.removeAttribute('required'));
            paypalInput.removeAttribute('required');

            // Activate selected method
            const activeButton = Array.from(buttons).find(btn =>
                btn.querySelector('i').classList.contains(method === 'stripe' ? 'fa-stripe' : 'fa-paypal')
            );

            if (activeButton) activeButton.classList.add('active');

            // Toggle sections and set requirements
            if (method === 'stripe') {
                stripeSect.classList.remove('hidden');
                paypalSect.classList.add('hidden');
                stripeInputs.forEach(input => input.setAttribute('required', 'true'));
            } else {
                stripeSect.classList.add('hidden');
                paypalSect.classList.remove('hidden');
                paypalInput.setAttribute('required', 'true');
            }
        }

        function togglePaymentForm() {
            showSection('paymentForm');
            document.querySelectorAll('.nav-menu li').forEach(item => {
                item.classList.remove('active');
            });
            const addFundsNavItem = document.querySelector('a[href="#add-funds"]').parentElement;
            addFundsNavItem.classList.add('active');

            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        function initializeDatePicker() {
            const dateFilterBtn = document.querySelector('.date-filter-btn');
            const popup = document.querySelector('.date-picker-popup');
            const cancelBtn = document.querySelector('.cancel-btn');
            const applyBtn = document.querySelector('.apply-btn');
            const startDate = document.getElementById('startDate');
            const startTime = document.getElementById('startTime');
            const endDate = document.getElementById('endDate');
            const endTime = document.getElementById('endTime');

            if (!dateFilterBtn) return;

            function formatDate(date, time) {
                const d = new Date(`${date}T${time}`);
                return d.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: false
                });
            }

            function updateDateRangeText() {
                const formattedText = `${formatDate(startDate.value, startTime.value)} - ${formatDate(endDate.value, endTime.value)}`;
                document.getElementById('dateRangeText').textContent = formattedText;
            }

            dateFilterBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                popup.classList.toggle('hidden');
            });

            cancelBtn.addEventListener('click', () => {
                popup.classList.add('hidden');
            });

            applyBtn.addEventListener('click', () => {
                updateDateRangeText();
                popup.classList.add('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!popup.contains(e.target) && !dateFilterBtn.contains(e.target)) {
                    popup.classList.add('hidden');
                }
            });

            popup.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }

        function showVerificationPage() {
            document.getElementById('verificationPage').classList.remove('hidden');
            document.getElementById('paymentForm').classList.add('hidden');
        }

        function hideVerificationPage() {
            document.getElementById('verificationPage').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
        }

        function showCampaignForm(mode, campaignId) {
            showSection('createCampaignSection');

            const title = document.getElementById('campaignFormTitle');
            const idElement = document.getElementById('campaignId');

            if (mode === 'edit' && campaignId) {
                title.textContent = 'Edit Campaign';
                idElement.textContent = campaignId;
                loadCampaignData(campaignId);
            } else {
                title.textContent = 'Create Campaign';
                idElement.textContent = '';
            }
        }

        function loadCampaignData(campaignId) {
            const campaignData = {
                id: campaignId,
                optimization: 'manual',
            };
            selectOptimization(campaignData.optimization, true);
        }

        function selectOptimization(type, skipDisabled = false) {
            const cards = document.querySelectorAll('.optimization-card');
            cards.forEach(card => {
                if (!card.classList.contains('disabled') || skipDisabled) {
                    card.classList.remove('active');
                    if (card.querySelector('.card-title').textContent.toLowerCase().includes(type)) {
                        card.classList.add('active');
                    }
                }
            });
        }

        // Initialize campaign steps
        document.addEventListener('DOMContentLoaded', function () {
            const stepItems = document.querySelectorAll('.step-item');
            stepItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();

                    // Update active states
                    stepItems.forEach(step => step.classList.remove('active'));
                    item.classList.add('active');

                    // Handle scrolling to sections
                    const stepNumber = item.querySelector('.step-number').textContent;
                    let targetSection;

                    switch (stepNumber) {
                        case '1':
                            targetSection = document.querySelector('.optimization-options');
                            break;
                        case '2':
                            targetSection = document.querySelector('.creative-section');
                            break;
                        // Add cases for other steps
                    }

                    if (targetSection) {
                        targetSection.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });

            // Handle priority button selection
            const priorityBtns = document.querySelectorAll('.priority-btn');
            priorityBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    priorityBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Handle adding new creative rows
            const addCreativeBtn = document.querySelector('.add-creative-btn');
            const creativeRows = document.querySelector('.creative-rows');

            if (addCreativeBtn && creativeRows) {
                addCreativeBtn.addEventListener('click', () => {
                    const newRow = creativeRows.querySelector('.creative-row').cloneNode(true);
                    // Clear input values
                    newRow.querySelectorAll('input').forEach(input => input.value = '');
                    creativeRows.appendChild(newRow);
                });
            }
        });
        // Function to check payment status and show appropriate screen
        async function checkAndShowPaymentStatus() {
            try {
                const response = await fetch('/api/payment/status', {
                    method: 'GET',
                    credentials: 'include', // Important for sending cookies
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    console.log("Authentication required. Redirecting to login...");
                    // Optional: Redirect to login page if unauthorized
                    // window.location.href = '/frontend/login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to fetch payment status');
                }

                const data = await response.json();

                // Update status based on payment status
                handlePaymentStatus(data);
            } catch (error) {
                console.error('Error checking payment status:', error);
            }
        }
        function handlePaymentStatus(data) {
            // Select the verification page and payment form elements
            const verificationPage = document.getElementById('verificationPage');
            const paymentForm = document.getElementById('paymentForm');
            if (paymentForm) {
                paymentForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    console.log('Payment form submitted');

                    // Get current payment method
                    const paymentMethod = document.querySelector('.payment-method.active').dataset.method;

                    // Prepare form data based on payment method
                    let formData = {
                        paymentMethod: paymentMethod,
                        amount: document.getElementById('amount').value
                    };

                    if (paymentMethod === 'stripe') {
                        formData.cardNumber = document.getElementById('cardNumber').value;
                        formData.expiryDate = document.getElementById('expiryDate').value;
                        formData.cvc = document.getElementById('cvc').value;
                    } else {
                        formData.paypalEmail = document.getElementById('paypalEmail').value;
                    }

                    console.log('Submitting payment data:', formData);

                    try {
                        const response = await fetch('/api/payment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData),
                            credentials: 'include'  // This is crucial - it ensures cookies are sent
                        });

                        console.log('Response status:', response.status);

                        const data = await response.json();
                        console.log('Response data:', data);

                        if (response.ok) {
                            // Hide payment form
                            document.getElementById('paymentForm').classList.add('hidden');

                            // Show success message
                            const statusLabel = document.querySelector('.payment-status-label');
                            statusLabel.textContent = 'Payment submitted successfully! We will process your request shortly.';
                            statusLabel.classList.add('success');
                            statusLabel.style.display = 'block';

                            // You might want to poll for status updates
                            checkPaymentStatus(data.paymentId);
                        } else {
                            // Show error message
                            const statusLabel = document.querySelector('.payment-status-label');
                            statusLabel.textContent = data.error || 'Failed to submit payment';
                            statusLabel.classList.add('error');
                            statusLabel.style.display = 'block';
                        }
                    } catch (error) {
                        console.error('Payment submission error:', error);

                        // Show error message
                        const statusLabel = document.querySelector('.payment-status-label');
                        statusLabel.textContent = 'An error occurred while submitting your payment';
                        statusLabel.classList.add('error');
                        statusLabel.style.display = 'block';
                    }
                });
            }
            const emptyState = document.getElementById('emptyState');

            // Update status based on payment status
            if (data.status === 'pending') {
                // Show verification page if payment is pending
                if (verificationPage && paymentForm) {
                    verificationPage.classList.remove('hidden');
                    paymentForm.classList.add('hidden');
                    emptyState.classList.add('hidden');
                }
            } else if (data.status === 'approved') {
                // Show a payment approved screen or update balance
                const approvedScreen = createPaymentApprovedScreen(data.amount);

                // Replace or append the approved screen
                const contentArea = document.querySelector('.content-area');
                if (contentArea) {
                    // Hide existing content
                    document.querySelectorAll('.content-area > div').forEach(section => {
                        section.classList.add('hidden');
                    });

                    // Append or replace with approved screen
                    contentArea.appendChild(approvedScreen);
                }
            } else if (data.status === 'rejected') {
                // Show payment rejected screen
                const rejectedScreen = createPaymentRejectedScreen();

                // Replace or append the rejected screen
                const contentArea = document.querySelector('.content-area');
                if (contentArea) {
                    // Hide existing content
                    document.querySelectorAll('.content-area > div').forEach(section => {
                        section.classList.add('hidden');
                    });

                    // Append or replace with rejected screen
                    contentArea.appendChild(rejectedScreen);
                }
            }
        }
        function isGoogleAuthenticated() {
            return localStorage.getItem('googleAuth') === 'true';
        }

        function setGoogleAuthenticated() {
            localStorage.setItem('googleAuth', 'true');
        }
        // Replace your existing submitPayment function with this one
        function submitPayment(e) {
            e.preventDefault();

            // Get the current payment method
            const currentPaymentMethod = document.querySelector('.payment-method.active').querySelector('i').classList.contains('fa-stripe') ? 'stripe' : 'paypal';

            // Get form elements
            const paymentForm = document.querySelector('.payment-form-content');

            // Find or create status label
            let statusLabel = document.querySelector('.payment-status-label');
            if (!statusLabel) {
                statusLabel = document.createElement('div');
                statusLabel.className = 'payment-status-label';
                paymentForm.appendChild(statusLabel);
            }

            statusLabel.className = 'payment-status-label'; // Reset classes
            statusLabel.style.display = 'none';

            // Validate the form
            if (!validateForm(currentPaymentMethod)) {
                return;
            }

            // Prepare form data
            const formData = {
                paymentMethod: currentPaymentMethod,
                amount: paymentForm.querySelector('input[name="amount"]').value
            };

            // Add method-specific details
            if (currentPaymentMethod === 'stripe') {
                formData.cardNumber = paymentForm.querySelector('input[name="cardNumber"]').value.replace(/\s/g, '');
                formData.expiryDate = paymentForm.querySelector('input[name="expiryDate"]').value;
                formData.cvc = paymentForm.querySelector('input[name="cvc"]').value;
            } else {
                formData.paypalEmail = document.getElementById('paypalEmail').value;
            }

            // Add Google authentication flag if applicable
            if (isGoogleAuthenticated()) {
                formData.googleAuth = true;
                formData.userEmail = localStorage.getItem('userEmail'); // Make sure to store this during login
            }

            console.log('Submitting payment data:', JSON.stringify(formData));

            // Submit the payment
            fetch('/api/payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Add a custom header for Google Auth
                    'X-Google-Auth': isGoogleAuthenticated() ? 'true' : 'false'
                },
                body: JSON.stringify(formData),
                credentials: 'include' // Still include credentials for regular auth
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            // Handle authentication error differently for Google users
                            if (isGoogleAuthenticated()) {
                                statusLabel.textContent = 'Google authentication session expired. Refreshing...';
                                statusLabel.classList.add('error');
                                statusLabel.style.display = 'block';

                                // Attempt to refresh the session by re-initiating Google auth
                                refreshGoogleAuth();
                                return;
                            } else {
                                statusLabel.textContent = 'Authentication required. Please log in again.';
                                statusLabel.classList.add('error');
                                statusLabel.style.display = 'block';

                                setTimeout(() => {
                                    window.location.href = '/frontend/login.html';
                                }, 2000);
                            }
                            throw new Error('Authentication required');
                        }
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        // Handle error from server
                        statusLabel.textContent = data.error;
                        statusLabel.classList.add('error');
                        statusLabel.style.display = 'block';
                        throw new Error(data.error);
                    }

                    // Success! Show verification page
                    const verificationPage = document.getElementById('verificationPage');
                    const paymentFormContainer = document.getElementById('paymentForm');

                    if (verificationPage && paymentFormContainer) {
                        verificationPage.classList.remove('hidden');
                        paymentFormContainer.classList.add('hidden');

                        // Reset form
                        paymentForm.reset();
                        selectPaymentMethod('stripe');

                        // Check payment status
                        if (data.paymentId) {
                            checkPaymentStatus(data.paymentId);
                        }
                    }
                })
                .catch(error => {
                    console.error('Payment error:', error);

                    // Only show error if not already shown
                    if (statusLabel.style.display !== 'block') {
                        statusLabel.textContent = 'An error occurred. Please try again.';
                        statusLabel.classList.add('error');
                        statusLabel.style.display = 'block';
                    }
                });
        }
        function refreshGoogleAuth() {
            // Store current URL to return here after auth
            localStorage.setItem('redirectAfterLogin', window.location.href);

            // Redirect to a simplified Google auth flow
            window.location.href = '/frontend/login.html?refreshAuth=true';
        }
        function checkGoogleAuthRefresh() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('googleAuth') && urlParams.get('googleAuth') === 'success') {
                // Clean up URL
                history.replaceState({}, document.title, window.location.pathname);

                // Set Google authentication flag
                setGoogleAuthenticated();

                // Show success message
                const statusLabel = document.createElement('div');
                statusLabel.className = 'payment-status-label success';
                statusLabel.textContent = 'Google authentication refreshed successfully.';
                statusLabel.style.display = 'block';

                document.querySelector('.content-area').appendChild(statusLabel);

                // Hide after 3 seconds
                setTimeout(() => {
                    statusLabel.style.display = 'none';
                }, 3000);
            }
        }
        function checkAuthCookie() {
            return document.cookie.includes('token=');
        }
        document.addEventListener('DOMContentLoaded', function () {
            const paymentForm = document.querySelector('.payment-form-content');

            if (paymentForm) {
                // Remove any existing event listeners (just in case)
                paymentForm.removeEventListener('submit', submitPayment);

                // Add the correct event listener
                paymentForm.addEventListener('submit', submitPayment);
            }

            // Check if user is coming from Google OAuth flow
            if (window.location.href.includes('code=')) {
                console.log('Detected OAuth flow completion');
            }
        });

        // Create payment approved screen
        function createPaymentApprovedScreen(amount) {
            const approvedScreen = document.createElement('div');
            approvedScreen.className = 'verification-container payment-approved-container';
            approvedScreen.innerHTML = `
        <div class="verification-content">
            <div class="payment-approved-icon">
                <i class="fa-solid fa-circle-check"></i>
            </div>
            <h1>Payment Approved!</h1>
            <p class="verification-text">Your payment of $${amount} has been successfully approved.</p>
            <button class="back-button" onclick="redirectToDashboard()">
                <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
            </button>
        </div>
    `;

            // Add styles to the screen
            const styles = `
        <style>
            .payment-approved-container {
                display: flex;
                justify-content: center;
                align-items: center;
                text-align: center;
                background-color: #f9fafb;
            }
            
            .payment-approved-icon {
                font-size: 5rem;
                color: #10b981;
                margin-bottom: 1rem;
            }
            
            .payment-approved-container h1 {
                color: #111827;
                margin-bottom: 1rem;
            }
            
            .payment-approved-container .verification-text {
                color: #6b7280;
                margin-bottom: 2rem;
            }
            
            .back-button {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 1rem;
                background: #f3f4f6;
                border: none;
                border-radius: 0.375rem;
                color: #374151;
                font-size: 0.875rem;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            
            .back-button:hover {
                background: #e5e7eb;
            }
        </style>
    `;

            approvedScreen.innerHTML += styles;
            return approvedScreen;
        }

        // Create payment rejected screen
        function createPaymentRejectedScreen() {
            const rejectedScreen = document.createElement('div');
            rejectedScreen.className = 'verification-container payment-rejected-container';
            rejectedScreen.innerHTML = `
        <div class="verification-content">
            <div class="payment-rejected-icon">
                <i class="fa-solid fa-times-circle"></i>
            </div>
            <h1>Payment Rejected</h1>
            <p class="verification-text">Unfortunately, your payment request has been rejected. Please contact support for more information.</p>
            <div class="questions-box">
                <h2>Need Help?</h2>
                <ul>
                    <li>Contact your personal manager directly</li>
                    <li>Use live-chat in the right corner of the screen</li>
                    <li>Email us at <a href="mailto:support@smartrichads.com">support@smartrichads.com</a></li>
                </ul>
            </div>
            <button class="back-button" onclick="redirectToDashboard()">
                <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
            </button>
        </div>
    `;

            // Add styles to the screen
            const styles = `
        <style>
            .payment-rejected-container {
                display: flex;
                justify-content: center;
                align-items: center;
                text-align: center;
                background-color: #f9fafb;
            }
            
            .payment-rejected-icon {
                font-size: 5rem;
                color: #ef4444;
                margin-bottom: 1rem;
            }
            
            .payment-rejected-container h1 {
                color: #111827;
                margin-bottom: 1rem;
            }
            
            .payment-rejected-container .verification-text {
                color: #6b7280;
                margin-bottom: 2rem;
            }
            
            .back-button {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 1rem;
                background: #f3f4f6;
                border: none;
                border-radius: 0.375rem;
                color: #374151;
                font-size: 0.875rem;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            
            .back-button:hover {
                background: #e5e7eb;
            }
        </style>
    `;

            rejectedScreen.innerHTML += styles;
            return rejectedScreen;
        }

        // Call this function when the page loads
        document.addEventListener('DOMContentLoaded', function () {
            const paymentForm = document.querySelector('.payment-form-content');

            if (paymentForm) {
                paymentForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    // Determine current payment method
                    const currentPaymentMethod = document.querySelector('.payment-method.active').querySelector('i').classList.contains('fa-stripe') ? 'stripe' : 'paypal';

                    // Validate form
                    if (!validateForm(currentPaymentMethod)) {
                        return;
                    }

                    // Prepare form data
                    let formData = {
                        paymentMethod: currentPaymentMethod,
                        amount: paymentForm.querySelector('input[name="amount"]').value
                    };

                    // Add method-specific details
                    if (currentPaymentMethod === 'stripe') {
                        formData.cardNumber = paymentForm.querySelector('input[name="cardNumber"]').value.replace(/\s/g, '');
                        formData.expiryDate = paymentForm.querySelector('input[name="expiryDate"]').value;
                        formData.cvc = paymentForm.querySelector('input[name="cvc"]').value;
                    } else {
                        formData.paypalEmail = document.getElementById('paypalEmail').value;
                    }

                    // Submit payment
                    const result = await submitPaymentForm(formData);

                    if (result.success) {
                        // Show verification page
                        const verificationPage = document.getElementById('verificationPage');
                        const paymentFormContainer = document.getElementById('paymentForm');

                        if (verificationPage && paymentFormContainer) {
                            verificationPage.classList.remove('hidden');
                            paymentFormContainer.classList.add('hidden');

                            // Reset form
                            paymentForm.reset();
                            selectPaymentMethod('stripe');

                            // Check payment status
                            checkPaymentStatus(result.data.paymentId);
                        }
                    } else {
                        // Show error
                        const statusLabel = document.querySelector('.payment-status-label') ||
                            document.createElement('div');
                        statusLabel.className = 'payment-status-label error';
                        statusLabel.textContent = result.error;

                        if (!document.querySelector('.payment-status-label')) {
                            paymentForm.appendChild(statusLabel);
                        }
                    }
                });
            }
        });
        function redirectToDashboard() {
            // Clear any stored payment status
            localStorage.removeItem('paymentStatus');

            // Reset the entire page content
            const dashboardContainer = document.querySelector('.dashboard');
            if (dashboardContainer) {
                // Reset to default view
                document.querySelectorAll('.content-area > div').forEach(section => {
                    section.classList.add('hidden');
                });

                // Show empty state
                const emptyState = document.getElementById('emptyState');
                if (emptyState) {
                    emptyState.classList.remove('hidden');
                }

                // Reset top nav title
                const topNavTitle = document.querySelector('.top-nav h1');
                if (topNavTitle) {
                    topNavTitle.textContent = 'Offers';
                }

                // Reset active sidebar item
                document.querySelectorAll('.nav-menu li').forEach(item => {
                    item.classList.remove('active');
                });
                const offersNavItem = document.querySelector('a[href="#offers"]').parentElement;
                if (offersNavItem) {
                    offersNavItem.classList.add('active');
                }
            }
        }
        function logout() {
            // Clear localStorage
            localStorage.removeItem('userType');
            localStorage.removeItem('userName');

            // Call the logout API
            fetch('/api/logout', {
                method: 'POST',
                credentials: 'include'
            }).then(() => {
                // Redirect to login page
                window.location.href = '/frontend/login.html';
            }).catch(error => {
                console.error('Logout error:', error);
                // Redirect anyway
                window.location.href = '/frontend/login.html';
            });
        }
        function initializeDashboard() {
            // Check Google auth status
            checkGoogleAuthRefresh();

            // Initialize date picker and other components
            initializeDatePicker();

            // Set up payment form submission with Google auth support
            const paymentForm = document.querySelector('.payment-form-content');
            if (paymentForm) {
                // Remove any existing event listeners
                const clonedForm = paymentForm.cloneNode(true);
                paymentForm.parentNode.replaceChild(clonedForm, paymentForm);

                // Add the event listener with Google auth support
                clonedForm.addEventListener('submit', submitPayment);
            }

            // Update UI based on auth method
            if (isGoogleAuthenticated()) {
                // Optional: Add visual indicator that user is Google-authenticated
                const topNav = document.querySelector('.top-nav');
                if (topNav) {
                    const googleBadge = document.createElement('div');
                    googleBadge.className = 'google-badge';
                    googleBadge.innerHTML = '<i class="fa-brands fa-google"></i>';
                    googleBadge.title = 'Google Authenticated';
                    googleBadge.style.margin = '0 10px';
                    googleBadge.style.color = '#4285F4';

                    const headerActions = topNav.querySelector('.header-actions');
                    if (headerActions) {
                        headerActions.prepend(googleBadge);
                    }
                }
            }
        }



        // Call initialization function when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeDashboard);
        // Enhanced submit button loader functionality
function setupSubmitButtonLoader() {
    const paymentForm = document.querySelector('.payment-form-content');
    const submitButton = paymentForm.querySelector('.submit-button');

    // Add loader styles
    const loaderStyles = `
    <style>
        .submit-button {
            position: relative;
            transition: all 0.3s ease;
        }
        .submit-button .button-text {
            transition: opacity 0.2s ease;
        }
        .submit-button .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        .submit-button.loading .button-text {
            opacity: 0;
        }
        .submit-button.loading .loader {
            display: block;
        }
        .loader-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>`;

    // Wrap button text and add loader
    submitButton.innerHTML = `
        ${loaderStyles}
        <span class="button-text">Submit for Approval</span>
        <div class="loader">
            <div class="loader-spinner"></div>
        </div>
    `;

    // Modify form submission to handle loading state
    paymentForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Show loading state
        submitButton.classList.add('loading');
        submitButton.disabled = true;

        try {
            // Your existing payment submission logic here
            const currentPaymentMethod = document.querySelector('.payment-method.active').querySelector('i').classList.contains('fa-stripe') ? 'stripe' : 'paypal';

            // Validate form
            if (!validateForm(currentPaymentMethod)) {
                throw new Error('Validation failed');
            }

            // Prepare form data
            let formData = {
                paymentMethod: currentPaymentMethod,
                amount: this.querySelector('input[name="amount"]').value
            };

            // Add method-specific details
            if (currentPaymentMethod === 'stripe') {
                formData.cardNumber = this.querySelector('input[name="cardNumber"]').value.replace(/\s/g, '');
                formData.expiryDate = this.querySelector('input[name="expiryDate"]').value;
                formData.cvc = this.querySelector('input[name="cvc"]').value;
            } else {
                formData.paypalEmail = document.getElementById('paypalEmail').value;
            }

            // Submit payment
            const response = await fetch('/api/payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    credentials: 'include'
                },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Payment submission failed');
            }

            const data = await response.json();

            // Show verification page
            const verificationPage = document.getElementById('verificationPage');
            const paymentFormContainer = document.getElementById('paymentForm');

            if (verificationPage && paymentFormContainer) {
                verificationPage.classList.remove('hidden');
                paymentFormContainer.classList.add('hidden');

                // Reset form
                this.reset();
                selectPaymentMethod('stripe');

                // Check payment status
                if (data.paymentId) {
                    checkPaymentStatus(data.paymentId);
                }
            }
        } catch (error) {
            console.error('Payment error:', error);

            // Show error message
            const statusLabel = document.querySelector('.payment-status-label') || 
                document.createElement('div');
            statusLabel.className = 'payment-status-label error';
            statusLabel.textContent = error.message || 'An error occurred. Please try again.';
            
            if (!document.querySelector('.payment-status-label')) {
                this.appendChild(statusLabel);
            }
        } finally {
            // Always remove loading state
            submitButton.classList.remove('loading');
            submitButton.disabled = false;
        }
    });
}

// Call this function when the page loads
document.addEventListener('DOMContentLoaded', setupSubmitButtonLoader);
    </script>

</body>

</html>